# Домашнее задание к занятию "Kubernetes. Причины появления. Команда kubectl"

### Цель задания

Для экспериментов и валидации ваших решений вам нужно подготовить тестовую среду для работы с Kubernetes. Оптимальное решение — развернуть на рабочей машине или на отдельной виртуальной машине MicroK8S.

------

### Чеклист готовности к домашнему заданию

1. Личный компьютер с ОС Linux или MacOS 

или

2. ВМ c ОС Linux в облаке либо ВМ на локальной машине для установки MicroK8S  

------

### Инструкция к заданию

1. Установка MicroK8S:
    - sudo apt update
    - sudo apt install snapd
    - sudo snap install microk8s --classic
    - добавить локального пользователя в группу `sudo usermod -a -G microk8s $USER`
    - изменить права на папку с конфигурацией `sudo chown -f -R $USER ~/.kube`

2. Полезные команды:
    - проверить статус `microk8s status --wait-ready`
    - подключиться к microK8s и получить информацию можно через команду `microk8s command`, например, `microk8s kubectl get nodes`
    - включить addon можно через команду `microk8s enable` 
    - список addon'ов `microk8s status`
    - вывод конфигурации `microk8s config`
    - проброс порта для подключения локально `microk8s kubectl port-forward -n kube-system service/kubernetes-dashboard 10443:443`

3. Настройка внешнего подключения:
    - Отредактировать файл /var/snap/microk8s/current/certs/csr.conf.template
    ```shell
    # [ alt_names ]
    # Add
    # IP.4 = 123.45.67.89
    ```
    - Обновить сертификаты `sudo microk8s refresh-certs --cert front-proxy-client.crt`

4. Установка kubectl:
    - curl -LO https://storage.googleapis.com/kubernetes-release/release/`curl -s https://storage.googleapis.com/kubernetes-release/release/stable.txt`/bin/linux/amd64/kubectl
    - chmod +x ./kubectl
    - sudo mv ./kubectl /usr/local/bin/kubectl 
    - настройка автодополнения в текущую сессию `bash source <(kubectl completion bash)`
    - добавление автодополнения в командную оболочку bash `echo "source <(kubectl completion bash)" >> ~/.bashrc`

------

### Инструменты/ дополнительные материалы, которые пригодятся для выполнения задания

1. [Инструкция](https://microk8s.io/docs/getting-started) по установке MicroK8S
2. [Инструкция](https://kubernetes.io/ru/docs/reference/kubectl/cheatsheet/#bash) по установке автодополнения **kubectl**
3. [Шпаргалка](https://kubernetes.io/ru/docs/reference/kubectl/cheatsheet/) по **kubectl**

------

### Задание 1. Установка MicroK8S

1. Установить MicroK8S на локальную машину или на удаленную виртуальную машину
2. Установить dashboard
3. Сгенерировать сертификат для подключения к внешнему ip-адресу

------

### Задание 2. Установка и настройка локального kubectl
1. Установить на локальную машину kubectl
2. Настроить локально подключение к кластеру
3. Подключиться к дашборду с помощью port-forward

------

### Правила приема работы

1. Домашняя работа оформляется в Github в своем репозитории в файле README.md. Выполненное домашнее задание пришлите ссылкой на .md-файл в вашем репозитории.
2. Файл README.md должен содержать скриншоты вывода команд `kubectl get nodes`, а также скриншот дашборда

------

### Ответ

Установлен MicroK8S и dashboard на локальную машину.  
![HW_12.1_t1.1.png](https://github.com/le0lex/devops-netology/blob/main/screen/HW_12.1_t1.1.png)
![HW_12.1_t1.2.1.png](https://github.com/le0lex/devops-netology/blob/main/screen/HW_12.1_t1.2.1.png)
  
Сгенерирован сертификат для подключения к внешнему ip-адресу  
![HW_12.1_t1.3.png](https://github.com/le0lex/devops-netology/blob/main/screen/HW_12.1_t1.3.png)
  
Установлен на локальную машину kubectl 
![HW_12.1_t2.1.1.png](https://github.com/le0lex/devops-netology/blob/main/screen/HW_12.1_t2.1.1.png) 
![HW_12.1_t2.1.2.png](https://github.com/le0lex/devops-netology/blob/main/screen/HW_12.1_t2.1.2.png) 
  
Настроено локально подключение к кластеру  
![HW_12.1_t2.2.png](https://github.com/le0lex/devops-netology/blob/main/screen/HW_12.1_t2.2.png)

Подключиться к дашборду с помощью port-forward  
![HW_12.1_t2.3.png](https://github.com/le0lex/devops-netology/blob/main/screen/HW_12.1_t2.3.png)
![HW_12.1_t1.2.png](https://github.com/le0lex/devops-netology/blob/main/screen/HW_12.1_t1.2.png)

Такжe в процессе установки и настройки была созадана директория '~/.kube' и файл config при помощи команды   
```
microk8s config > config
```

Сам config  
```
apiVersion: v1
clusters:
- cluster:
    certificate-authority-data: LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSUREekNDQWZlZ0F3SUJBZ0lVTk1tMjc4ZWN2RzRtSUhqWW01eEQyVnlodWdzd0RRWUpLb1pJaHZjTkFRRUwKQlFBd0Z6RVZNQk1HQTFVRUF3d01NVEF1TVRVeUxqRTRNeTR4TUI0WERUSXpNREV4TWpFMk1UUTFNbG9YRFRNegpNREV3T1RFMk1UUTFNbG93RnpFVk1CTUdBMVVFQXd3TU1UQXVNVFV5TGpFNE15NHhNSUlCSWpBTkJna3Foa2lHCjl3MEJBUUVGQUFPQ0FROEFNSUlCQ2dLQ0FRRUF0U2xJT080WmdkOU92eFR0UUFGcHFDV1JBSE5vMXRUWFRpTkcKUUxFZFA3Z2kxUDhWcmNxb1pGMktRcFY4M29ZU2ZVU1hGYXNQT0tXVmlBNkhoZ1JBRlAycUR0SGdVUm5wclhIbwpCbHhkVjdTbDJ2MkxMYnNKdGhhOWlnY0FKMEM1WlpyUWJNaUMveWFNa1VjTFoyZ2lhTWtDQmZ5bkxMNi90U3N5ClpTL3ZoNmtyMEpnTFkvbUF2S0Y0ZXZ2MjBZWGpXZjdTaGZlaWhNMy9MeHVVbXB0K2NDZ3IxQW55RHduZUJMYkkKMGpXa1ZHVmhUUkF1ZE9CdlE0czNiU1RRS2NPWTRRYzBGNEI4anlHUlkyck9XdkxLQ2R3a25UOE1VS1BWNWJRegpCb29SZFJERDhmV2pQMHI3S2hjWXhNSXJ5V21pMUJVMUpUbXR3K3o1Ty9QbFJMQlBkUUlEQVFBQm8xTXdVVEFkCkJnTlZIUTRFRmdRVUtZMUZDQjh1bHJGZURZN0ZNekpFQzlicGV1SXdId1lEVlIwakJCZ3dGb0FVS1kxRkNCOHUKbHJGZURZN0ZNekpFQzlicGV1SXdEd1lEVlIwVEFRSC9CQVV3QXdFQi96QU5CZ2txaGtpRzl3MEJBUXNGQUFPQwpBUUVBQ1VhQi9ta2JheFFsMEJ1RVp3RkFsdnp5S0JXYy9vbzNDU3UwUE53MGY2MXA1UER1WlNCZ1NOWFQ4QmY0Cjh2T2N1ZTl6dVJ0aXFERmFUOG9acm1IWEdvRG1nazV3RGdubnpuQ0xtaFE0a1NqMm54T1ZMdUJhMVBhdVZwVEoKSEhHVHV0OVVkLzJabHNxNHh6cUJjclBHdGdYSkF0cWk5UHVUMkFlMXBIQVh5NGRzb1VmM1ZCWEFZbFk2bVZVMwo0NnJ4Q3lsWWVOVzNmNkFMWm5takowcjRqWG12MW85TnYwWEFVMWsxcmFGZWgyS3VOREhHcmJ4eHFsYkNGQVRVCmpjK0hFZGU1T3JlTjBJcGNYRkkrSDMxaXk0NkZVN3hYc0kwNyt6MFViN2t1ZEJCT2N0cWpKVmpCQzlQRW1GeG4Ka3JyY3A0SUE5dW1xOExIYmJBM3VocUlyNGc9PQotLS0tLUVORCBDRVJUSUZJQ0FURS0tLS0tCg==
    server: https://10.0.2.15:16443
  name: microk8s-cluster
contexts:
- context:
    cluster: microk8s-cluster
    user: admin
  name: microk8s
current-context: microk8s
kind: Config
preferences: {}
users:
- name: admin
  user:
    token: YUlpa2ZkSThYZkt0Q3dWQWc4emw5V2RyeDdHNEN0cE1KYWc1Z0YyZGR5bz0K
```
  
---

# Домашнее задание к занятию "11.4 Микросервисы: масштабирование"

Вы работаете в крупной компанию, которая строит систему на основе микросервисной архитектуры.
Вам как DevOps специалисту необходимо выдвинуть предложение по организации инфраструктуры, для разработки и эксплуатации.

## Задача 1: Кластеризация

Предложите решение для обеспечения развертывания, запуска и управления приложениями.
Решение может состоять из одного или нескольких программных продуктов и должно описывать способы и принципы их взаимодействия.

Решение должно соответствовать следующим требованиям:
- Поддержка контейнеров;
- Обеспечивать обнаружение сервисов и маршрутизацию запросов;
- Обеспечивать возможность горизонтального масштабирования;
- Обеспечивать возможность автоматического масштабирования;
- Обеспечивать явное разделение ресурсов доступных извне и внутри системы;
- Обеспечивать возможность конфигурировать приложения с помощью переменных среды, в том числе с возможностью безопасного хранения чувствительных данных таких как пароли, ключи доступа, ключи шифрования и т.п.

Обоснуйте свой выбор.

### Ответ  

|Требования|K8s|Docker Swarm|Nomad|Apache Mesos|
|----------|---|------------|-----|------------|
|Поддержка контейнеров|+|+|+|+|
|Обеспечивать обнаружение сервисов и маршрутизацию запросов|+|+|-|+|
|Обеспечивать возможность горизонтального масштабирования|+|+|+|+|
|Обеспечивать возможность автоматического масштабирования|+|-|+|+|
|Обеспечивать явное разделение ресурсов доступных извне и внутри системы|+|-|+|+|
|Обеспечивать возможность конфигурировать приложения с помощью переменных среды, в том числе с возможностью безопасного хранения чувствительных данных таких как пароли, ключи доступа, ключи шифрования и т.п.|+|+|+|+|

Лучше выбрать Kubernetes, потому что он подходит для высоконагруженных сайтов и приложений, благодаря автоматическому масштабированию до тысяч узлов, отказоустойчивости, выделенным балансировщикам нагрузки для эффективного распределения трафика. Имеет большое сообщество среди всех оркестраторов, что обеспечивает богатый инструментарий и большое число готовых решений.

---


# Домашнее задание к занятию 11.3 "Микросервисы: подходы"

Вы работаете в крупной компанию, которая строит систему на основе микросервисной архитектуры.
Вам как DevOps специалисту необходимо выдвинуть предложение по организации инфраструктуры, для разработки и эксплуатации.


## Задача 1: Обеспечить разработку

Предложите решение для обеспечения процесса разработки: хранение исходного кода, непрерывная интеграция и непрерывная поставка. 
Решение может состоять из одного или нескольких программных продуктов и должно описывать способы и принципы их взаимодействия.

Решение должно соответствовать следующим требованиям:
- Облачная система;
- Система контроля версий Git;
- Репозиторий на каждый сервис;
- Запуск сборки по событию из системы контроля версий;
- Запуск сборки по кнопке с указанием параметров;
- Возможность привязать настройки к каждой сборке;
- Возможность создания шаблонов для различных конфигураций сборок;
- Возможность безопасного хранения секретных данных: пароли, ключи доступа;
- Несколько конфигураций для сборки из одного репозитория;
- Кастомные шаги при сборке;
- Собственные докер образы для сборки проектов;
- Возможность развернуть агентов сборки на собственных серверах;
- Возможность параллельного запуска нескольких сборок;
- Возможность параллельного запуска тестов;

Обоснуйте свой выбор.

### Ответ:  
  
Можно использовать Gitlab + Jenkins.  

Gitlab - комплексный продукт для управления проектом, который позволяет:  

- хранить исходный код;
- контролировать жизненный цикл;
- строить конвейер и управлять им;
- создавать странички с документацией;
- сохранять и использовать артефакты сборок;
- изменять и создавать файлы в репозитории при помощи встроенной IDE;
- единого web-интерфейса;

Jenkins – для управления CI\CD процессами:

- Master – основной процесс Jenkins, он же исполнитель на ноде
- Agent – java процесс на отдельном хосте для выполнения job
- Job – описание рутинного рабочего процесса
- Job может быть нескольких видов, основные
    - Freestyle
    - Pipeline
- Существует огромный набор расширений функционала
- Инструмент обладает гибкостью в настройке
- Полностью бесплатен

## Задача 2: Логи

Предложите решение для обеспечения сбора и анализа логов сервисов в микросервисной архитектуре.
Решение может состоять из одного или нескольких программных продуктов и должно описывать способы и принципы их взаимодействия.

Решение должно соответствовать следующим требованиям:
- Сбор логов в центральное хранилище со всех хостов обслуживающих систему;
- Минимальные требования к приложениям, сбор логов из stdout;
- Гарантированная доставка логов до центрального хранилища;
- Обеспечение поиска и фильтрации по записям логов;
- Обеспечение пользовательского интерфейса с возможностью предоставления доступа разработчикам для поиска по записям логов;
- Возможность дать ссылку на сохраненный поиск по записям логов;

Обоснуйте свой выбор.

### Ответ:  

Основным на текущий момент является система сбора логов, построенная на основе стэка технологий Elasticsearch-Logstash-Kibana (ELK).  

Данный стэк позволяет “из коробки” получить средство агрегации и трансформации, хранения и визуализации данных логирования.

Наиболее распространенное решения для построения системы сбора логов на основе ELK является архитектура “Hot-Warm”.

Кластерные узлы, помеченные, как “Hot” осуществляют хранение и сбор “быстрых” данных логирования, например за последние сутки. 

Кластерные узлы, помеченные, как “Warm” осуществляют хранение и сбор “медленных” данных логирования, например всё что следует за текущими сутками.

Также возможно использовать “Cold” узлы, которые, например, хранят данные старше 30 дней.

Сбор логов осуществляется двумя путями:

- Приложение пишет логи напрямую в logstash (например, посредством tcp)
- Сбор производит Filebeat, который считывает данные логов из файлов.

## Задача 3: Мониторинг

Предложите решение для обеспечения сбора и анализа состояния хостов и сервисов в микросервисной архитектуре.
Решение может состоять из одного или нескольких программных продуктов и должно описывать способы и принципы их взаимодействия.

Решение должно соответствовать следующим требованиям:
- Сбор метрик со всех хостов, обслуживающих систему;
- Сбор метрик состояния ресурсов хостов: CPU, RAM, HDD, Network;
- Сбор метрик потребляемых ресурсов для каждого сервиса: CPU, RAM, HDD, Network;
- Сбор метрик, специфичных для каждого сервиса;
- Пользовательский интерфейс с возможностью делать запросы и агрегировать информацию;
- Пользовательский интерфейс с возможность настраивать различные панели для отслеживания состояния системы;

Обоснуйте свой выбор.

### Ответ:

Лучше всего подходит связка Prometheus и Grafana

Prometheus - представляет из себя набор компонентов для эффективного мониторинга систем. 

Prometheus работает в соответствии с pull-моделью.

Набор компонентов Prometheus стэка:
- Exporter (агент для сборки метрик с хост-машин и хранения до сбора системой мониторинга)
- Server (хранение данных и их менеджмент)
- Web UI (веб интерфейс для доступа к данным и конфигурирования системы)
- Alert Manager (система оповещения)

Данный стэк технологий представляет из себя “коробочную” версию системы мониторинга, которую можно использовать, без дополнительных инструментов.

Grafana является самой популярной в мире технологией визуализации, используемой для создания панелей мониторинга.

Поддерживает множество источников данных.

Имеет встроенный функционал оповещений (алёртинга) на пороговые события временных рядов.

---



# Домашнее задание к занятию "11.02 Микросервисы: принципы"  
  
Вы работаете в крупной компанию, которая строит систему на основе микросервисной архитектуры.  
Вам как DevOps специалисту необходимо выдвинуть предложение по организации инфраструктуры, для разработки и эксплуатации.  
  
## Задача 1: API Gateway   
  
Предложите решение для обеспечения реализации API Gateway. Составьте сравнительную таблицу возможностей различных программных решений. На основе таблицы сделайте выбор решения.  
  
Решение должно соответствовать следующим требованиям:  
- Маршрутизация запросов к нужному сервису на основе конфигурации  
- Возможность проверки аутентификационной информации в запросах  
- Обеспечение терминации HTTPS 
  
Обоснуйте свой выбор.  
  
#### <b>Ответ:</b>  
---

|   |Azure|Amazon|Yandex|Nginx|Haproxy|Kong|Apache APISIX|Tyk|Goku|Gloo|Istio|MuleSoft|Apigee|
|---|-----|------|------|-----|-------|----|-------------|---|----|----|-----|--------|------|
|Маршрутизация| + | + | + | + | + | + | + | + | + | + | + | + | + |
|Аутентификация| + | + | + | + | + | + | + | + | + | + | + | + | + |
|Терминация HTTPS| + | + | + | + | + | + | + | + | + | + | + | + | + |
  
Выбор будет зависеть от инфраструктуры и поставленных задач. 
  
Облачные API Gateway удобны в использовании и значительно экономят время разработки, поддерживают интеграцию с облачными сервисами и настраиваются очень быстро. Apigee и MuleSoft — одни из лучших инструментов управления API. Решение с открытым исходным кодом - Kong, его базовый бесплатный функционал также удовлетворяет требованиям задачи.  
  
## Задача 2: Брокер сообщений  
  
Составьте таблицу возможностей различных брокеров сообщений. На основе таблицы сделайте обоснованный выбор решения.   
  
Решение должно соответствовать следующим требованиям:  
- Поддержка кластеризации для обеспечения надежности  
- Хранение сообщений на диске в процессе доставки  
- Высокая скорость работы  
- Поддержка различных форматов сообщений  
- Разделение прав доступа к различным потокам сообщений  
- Протота эксплуатации  

#### <b>Ответ:</b>  
  
|   |Кластеризация|Хранение|Скорость|Форматы|Права|Простота|
|---|-------------|--------|--------|-------|-----|--------|
|RabbitMQ| + | + | + | + | + | - |
|Apache Kafka| + | - | + | + | + | - |
|AWS SQS/SNS| + | + | + | + | + | + |
|Redis| + | + | ++ | + | + | + |
|Qpid| + |	+ |	- | + |	+ | - |
|SwiftMQ| + | + | - | + | + | - |
|Artemis| + | + | - | + | + | + |
|Apollo| - | + | - | + | + | + |
Выбирая нужный брокер, следует исходить из понимания системы и её потребностей:  
  
- RabbitMQ - если нужно построение сложных сценариев маршрутизации  
  
- Apache Kafka - работает с большими потоками данных, обеспечивает сохранность сообщений и возможность многократной повторной обработки  
  
- AWS SQS/SNS - минимальные накладные расходы и быстрая настройка, подойдет для стартапов  
  
---


# Домашнее задание к занятию "Введение в микросервисы"

## Задача 1: Интернет Магазин

Руководство крупного интернет магазина у которого постоянно растёт пользовательская база и количество заказов рассматривает возможность переделки своей внутренней ИТ системы на основе микросервисов. 

Вас пригласили в качестве консультанта для оценки целесообразности перехода на микросервисную архитектуру. 

Опишите какие выгоды может получить компания от перехода на микросервисную архитектуру и какие проблемы необходимо будет решить в первую очередь.

---
Ответ
---

Выгоды от перехода на микросервисы:

 - Гибкость с точки зрения горизонтального масштабирования, то есть возможность масштабировать только те сервисы, которые этого требуют. Когда нагрузка снизится, можно сократить лишние ресурсы.
 - Проще вводить новый функционал сервисов без остановки всей системы, а также переисывать систему по частям, внедряя новые технологии для оптимизации и ускорения работы сервича в целом.
 - Отсутствие единой точки отказа, увеличивается отказоустойчивость системы.
 - Отдельно взятый микросервис проще разрабатывать и следить за жизненным циклом, то есть обновлять, дорабатывать, тестировать и т.д.
 - Подбор персонала становится проще, так как под каждый микросервис можно набрать свою команду узкопрофильных специалистов. По этой же причине, проще управлять жизненным циклом продукта в целом.

Проблемы, требующие решения:
 - Не рекомендуется внедрять микросервисы, если проект только на стадии проработки.
 - При проработке решения должно быть учтено огромное количество архитектурных вопросов, которые бывает сложно спрогнозировать.
 - Большим количеством микросервисов сложно управлять.
 - Микросервисы потребуют изменения подходов к инфраструктуре
 - Требуеются узкопрофильные специалисты с глубоким погружением в тему.
 - Необходимо решать вопросы автоматизации сборки и тестирования, поддержки документации в актальном состоянии на каждый микросервис, совместимости API. 

 ---
