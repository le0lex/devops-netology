# Домашнее задание к занятию "Обновление приложений"

### Цель задания

Выбрать и настроить стратегию обновления приложения.

### Чеклист готовности к домашнему заданию

1. Кластер k8s.

### Инструменты и дополнительные материалы, которые пригодятся для выполнения задания

1. [Документация Updating a Deployment](https://kubernetes.io/docs/concepts/workloads/controllers/deployment/#updating-a-deployment)
2. [Статья про стратегии обновлений](https://habr.com/ru/companies/flant/articles/471620/)

-----

### Задание 1. Выбрать стратегию обновления приложения и описать ваш выбор.

1. Имеется приложение, состоящее из нескольких реплик, которое требуется обновить.
2. Ресурсы, выделенные для приложения ограничены, и нет возможности их увеличить.
3. Запас по ресурсам в менее загруженный момент времени составляет 20%.
4. Обновление мажорное, новые версии приложения не умеют работать со старыми.
5. Какую стратегию обновления выберете и почему?
  
**Ответ:**  

В зависимости от специфики использования приложения я бы использовал следуюшие стратегии:  
  
1. Eсли допустима недоступность приложения, то я бы выбрал стратегию **Recreate**, так как у нас ограниченное количество дополнительных ресурсов. Старые реплики будут уничтожены и запущены обновленные вместо них. Кроме того обновление мажорное, то есть части приложения будут обновлены все вместе, что защитит от проблем с совместимостью.
2. Если недоступность приложения недопустима, то я бы выбрал стратегию **Canary update**, так как можно развернуть одну или несколько реплик (точное количество у нас не указано), используя доступные ресурсы в 20%, но при этом надо перенаправлять трафик частично, чтобы избежать перегрузок и прерывания сервиса. Постепенно уменшаем количество старых реплик на новые и постепенно переводим на новые реплики трафик по какому-нибудь признаку.
  
### Задание 2. Обновить приложение.

1. Создать deployment приложения с контейнерами nginx и multitool. Версию nginx взять 1.19. Кол-во реплик - 5.
2. Обновить версию nginx в приложении до версии 1.20, сократив время обновления до минимума. Приложение должно быть доступно.
3. Попытаться обновить nginx до версии 1.28, приложение должно оставаться доступным.
4. Откатиться после неудачного обновления.
  
**Ответ:**  
  
Для обновления использую стратегию Rolling Update. Поскольку, главное условия это доступность и скорость, то работающими надо оставить хотя бы 2 реплики, а остальные подлежат обновлению, поэтому  использую параметр maxUnavailable: 3 и maxSurge: 2 (ограничений по ресурсам у нас нет). Тогда у нас пойдут на обновление 5 реплик, а 2 останутся доступными. Если оставить доступной одну, то не будет резервирования, что может привести к прерыванию сервиса. За счет maxSurge: 2 сразу же создадутся 5 новых реплик. Если обновление пойдет удачно, то у нас на первом же заходе будут готовы все 5 реплик. Оставшиеся 2 старые реплики будут остановлены. Если обновление пойдет неудачно, то у нас останется 2 старых работающих реплики.
  
Создаём deployment используя [манифест](https://github.com/le0lex/devops-netology/blob/1aef63e165d2ce52c123203480b790cc0ed7c0fc/HW_14.4/nginx-multitool.yaml)
  
Deployment создался успешно:
![deployment_ver1](https://github.com/le0lex/devops-netology/blob/main/screen/HW_14.4_t2_002.png)
  
меняем версию nginx в манифесте:
  
```
      containers:
      - name: nginx
        image: nginx:1.20
        ports:
```
  
Применяю манифест:  
обновление прошло успешно, остановилось 3 старых реплики и создается 5 новых:  
![updating](https://github.com/le0lex/devops-netology/blob/main/screen/HW_14.4_t2_002.png)
![deployment_ver2](https://github.com/le0lex/devops-netology/blob/main/screen/HW_14.4_t2_003.png)
![deployment_history](https://github.com/le0lex/devops-netology/blob/main/screen/HW_14.4_t2_004.png)
  
Меняю версию nginx в манифесте:  


```
      containers:
      - name: nginx
        image: nginx:1.28
        ports:
```
  
Обновление неуспешно, пошли ошибки создании подов, но остаются рабочими 2 реплики, за счет чего приложение остается доступным:  
![updating](https://github.com/le0lex/devops-netology/blob/main/screen/HW_14.4_t2_005.png)
![updating_error](https://github.com/le0lex/devops-netology/blob/main/screen/HW_14.4_t2_006.png)
  
Откатываю обновление командой `kubectl rollout undo deployment nginx-multitool`.   
![deployment_history](https://github.com/le0lex/devops-netology/blob/main/screen/HW_14.4_t2_007.png)
  
Откат на предыдущую версию прошел успешно:  
![deployment_history](https://github.com/le0lex/devops-netology/blob/main/screen/HW_14.4_t2_008.png)
  
## Дополнительные задания (со звездочкой*)

**Настоятельно рекомендуем выполнять все задания под звёздочкой.**   Их выполнение поможет глубже разобраться в материале.   
Задания под звёздочкой дополнительные (необязательные к выполнению) и никак не повлияют на получение вами зачета по этому домашнему заданию. 

### Задание 3*. Создать Canary deployment.

1. Создать 2 deployment'а приложения nginx.
2. При помощи разных ConfigMap сделать 2 версии приложения (веб-страницы).
3. С помощью ingress создать канареечный деплоймент, чтобы можно было часть трафика перебросить на разные версии приложения.

